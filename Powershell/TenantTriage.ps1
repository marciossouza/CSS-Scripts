# TenantTriage.ps1 MingChen@microsoft.com
#   Use pre-configured searches in Entra Domain Services with the Tenant ID to gather information about the tenant.
#       Feel free to modify according to your need.
#   Tip for modifying this script: 
#       When copying a Parameterized Link from Prod endpoint using your reference TenantID, replace " with `" as URL string. For this script, reference Tenant ID is
    $refTenantID ="4f8960a2-b031-4aab-ab13-ad5641ca5dd4"
    $DefaultSelection = 0 #The default ComboBox selection to enable trend checks in the fleet.
# How to fish, Copilot starter prompt:
#   Write a powershell script with 3 radio buttons 'Prod', 'Fairfax' and 'Mooncake' (with default of Prod) follow by text inputbox for $TenantId (with default value from clipboard) follow by pulldown selection list of $scernerio string array containing description string and URL strings (with default of first item), end the form with OK and cancel. Please output what user selected. 
#
Add-Type -AssemblyName System.Windows.Forms
    Add-Type -AssemblyName System.Drawing
# Create the form
    $form = New-Object System.Windows.Forms.Form
        $form.Text = 'Entra Domain Services Tenant Triage 5-2'
#region        
        $form.Icon = [System.Drawing.SystemIcons]::Information
        $form.Size = New-Object System.Drawing.Size(405,200)
        $form.StartPosition = 'CenterScreen'
# 'OK', 'Cancel' and 'Feedback'
    $okButton = New-Object System.Windows.Forms.Button
        $okButton.Location = New-Object System.Drawing.Point(50,130)
        $okButton.Size = New-Object System.Drawing.Size(75,23)
        $okButton.Text = '&OK'
        $okButton.DialogResult = [System.Windows.Forms.DialogResult]::OK
        $form.AcceptButton = $okButton
        $form.Controls.Add($okButton)
    $cancelButton = New-Object System.Windows.Forms.Button
        $cancelButton.Location = New-Object System.Drawing.Point(160,130)
        $cancelButton.Size = New-Object System.Drawing.Size(75,23)
        $cancelButton.Text = '&Cancel'
        $cancelButton.DialogResult = [System.Windows.Forms.DialogResult]::Cancel
        $form.CancelButton = $cancelButton
        $form.Controls.Add($cancelButton)
    $feedbackButton = New-Object System.Windows.Forms.Button
        $feedbackButton.Location = New-Object Drawing.Point(280, 130)
        $feedbackButton.Size = New-Object System.Drawing.Size(75,23)
        $feedbackButton.Text = "Feedback"
        $feedbackButton.Add_Click({ Start-Process "mailto:mingchen@microsoft.com;anfranca@microsoft.com?subject=Entra Domain Services Tenant Triage v3-31 script feedback." })
        $form.Controls.Add($feedbackButton)
# Get Endpoints using RadioButton
    $endpointProd = New-Object System.Windows.Forms.RadioButton
        $endpointProd.Location = New-Object System.Drawing.Point(10,20)
        $endpointProd.Size = New-Object System.Drawing.Size(104,24)
        $endpointProd.Text = '&Prod'
        $endpointProd.Checked = $true
        $form.Controls.Add($endpointProd)
    $endpointFairfax = New-Object System.Windows.Forms.RadioButton
        $endpointFairfax.Location = New-Object System.Drawing.Point(150,20)
        $endpointFairfax.Size = New-Object System.Drawing.Size(104,24)
        $endpointFairfax.Text = '&Fairfax'
        $form.Controls.Add($endpointFairfax)
    $endpointMooncake = New-Object System.Windows.Forms.RadioButton
        $endpointMooncake.Location = New-Object System.Drawing.Point(290,20)
        $endpointMooncake.Size = New-Object System.Drawing.Size(104,24)
        $endpointMooncake.Text = '&Mooncake'
        $form.Controls.Add($endpointMooncake)
# Get TenantID using TextBox
    $label = New-Object System.Windows.Forms.Label
        $label.Location = New-Object System.Drawing.Point(10,50)
        $label.Size = New-Object System.Drawing.Size(280,20)
        $label.Text = 'Please enter the Tenant ID:'
        $form.Controls.Add($label)
    $textBox = New-Object System.Windows.Forms.TextBox
        $textBox.Location = New-Object System.Drawing.Point(10,70)
        $textBox.Size = New-Object System.Drawing.Size(370,20)
        $textBox.Text = Get-Clipboard
        $TenantID = $textBox.Text
        $form.Controls.Add($textBox)
#endregion
# Get Scenarios using ComboBox
    $comboBox = New-Object System.Windows.Forms.ComboBox
        $comboBox.Location = New-Object System.Drawing.Point(10,100)
        $comboBox.Size = New-Object System.Drawing.Size(370,200)
        $comboBox.DropDownHeight = 200  
        $scenarios = @(
            @{Description='0 General Tenant information (Full)'; URL=@(
                "https://portal.microsoftgeneva.com/logs/dgrep?be=DGrep&offset=-15&offsetUnit=Hours&UTC=true&ep=Diagnostics%20PROD&ns=dcaasprod&en=DCAnalyticsDataEvent,DomainAnalyticsDataEvent&scopingConditions=[[`"ScaleUnit`",`"dcaasarm-prod-su-1`"]]&conditions=[[`"contextId`",`"%3D%3D`",`"4f8960a2-b031-4aab-ab13-ad5641ca5dd4`"]]&clientQuery=//%20SubscriptionInfo%0Aselect%20env_time,%20domainName,%20contextId%20as%20TenantID,%20clientSubscriptionId%20as%20CustomerSub,%20hostSubscriptionId%20as%20MsftSub,%20vmName%20,region,%20env_cloud_location%20as%20Cloud,%20domainStatus%20as%20Status,%20roleSize%20as%20VmSku,%20ldapsStatus%20as%20Ldap,%20ldapsPublicAccessStatus%20as%20LdapPub,%20syncPasswordFlag%20as%20PwdSync%0Adistinct%0Agroupby%20domainName,%20TenantID,%20CustomerSub,%20MsftSub,%20VmName,%20region,%20Cloud,%20Status,%20VmSku,%20Ldap,%20LdapPub,%20PwdSync%0A&aggregates=[`"Count%20by%20domainStatus`",`"Count%20by%20domainName`",`"Count%20by%20resultType`"]&chartEditorVisible=true&chartType=line&chartLayers=[[`"New%20Layer`",`"`"]]%20",
                "https://portal.microsoftgeneva.com/logs/dgrep?be=DGrep&offset=-3&offsetUnit=Hours&UTC=true&ep=Diagnostics%20PROD&ns=dcaasprod&en=TraceEvent&scopingConditions=[[`"ScaleUnit`",`"dcaasarm-prod-su-1`"]]&conditions=[[`"contextId`",`"%3D%3D`",`"4f8960a2-b031-4aab-ab13-ad5641ca5dd4`"],[`"message`",`"contains%20any%20of`",`"PrimaryZones,%20DomainServiceConverter.GetDomainServiceV2:%20Returning%20`"]]&kqlClientQuery=//%20DNS%20and%20DomainServiceInfo%0Asource%0A|%20project%20env_time,%20domainName,%20message,%20RootHint%3Dextract('`"UseRootHint`":([^`"]%2B),',1,%20message),%20IPAddress%3Dextract('IPAddress`":([^,]%2B])',1,%20message)%0A|%20sort%20by%20env_time%20desc%0A&chartEditorVisible=true&chartType=line&chartLayers=[[`"`",`"groupby%20StartTime.roundDown(\`"PT30S\`")%20as%20X,%20operationName\nwhere%20operationName%20%3D%3D%20\`"StorageGetBlob\`"%20||%20operationName%20%3D%3D%20\`"AuthenticationGetTopLevelMetadata\`"%20||%20operationName%20%3D%3D%20\`"AuthenticationGetKeysMetadataTrustedKeys\`"%20||%20operationName%20%3D%3D%20\`"AuthenticationAcquireToken\`"\nlet%20durationMs%20%3D%20Average(durationMs)`"]]%20",
                "https://portal.microsoftgeneva.com/logs/dgrep?be=DGrep&offset=-15&offsetUnit=Hours&UTC=false&ep=Diagnostics%20PROD&ns=dcaasprod&en=DomainEvaluationEvent&scopingConditions=[[`"ScaleUnit`",`"dcaasarm-prod-su-1`"]]&conditions=[[`"contextId`",`"%3D%3D`",`"4f8960a2-b031-4aab-ab13-ad5641ca5dd4`"],[`"operationName`",`"%3D%3D`",`"SyncAgentEvaluator`"],[`"resultDescription`",`"contains`",`"SyncHealthStatus`"]]&kqlClientQuery=//%20TenantSize%20%26%20SyncStatus%0Asource%20%20%20%20%20%20%20%20%20%20%0A|%20extend%20LocalUsers%20%3D%20extract('UserAccountsCount`":([^,]%2B)',1,%20resultDescription)%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A|%20extend%20LocalGroups%20%3D%20extract('GroupAccountsCount`":([^,]%2B)',1,%20resultDescription)%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A|%20extend%20SyncActive%20%3D%20extract('SyncActive:%20([^w].*)',1,%20resultDescription)%20%20%20%20%20%20%20%20%20%0A|%20extend%20SyncUsers%20%3D%20extract('DcaasOuUserAccountsCount`":([^,]%2B)',1,%20resultDescription)%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A|%20extend%20SyncGroups%20%3D%20extract('DcaasOuGroupAccountsCount`":([^,]%2B)',1,%20resultDescription)%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A|%20extend%20SyncObjects%20%3D%20toint(SyncUsers)%20%2B%20toint(SyncGroups)%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A|%20extend%20SyncLinks%20%3D%20extract('DcaasOuMembershipCount`":([^}]%2B)',1,%20resultDescription)%20%20%20%20%20%0A%0A|%20project%20env_time,%20domainName,%20domainRegion,%20resultDescription,%20SyncActive,%20LocalUsers,%20LocalGroups,%20SyncUsers,%20SyncGroups,%20SyncObjects,%20SyncLinks%0A|%20sort%20by%20env_time%20desc&chartEditorVisible=false&chartType=line&chartLayers=[[`"Object`",`"groupby%20env_time.roundDown(\`"PT1H\`")%20as%20X\nlet%20Counts%20%3D%20Max(Objects)`"]]%20",
                "https://portal.microsoftgeneva.com/logs/dgrep?be=DGrep&offset=-7&offsetUnit=Days&UTC=true&ep=Diagnostics%20PROD&ns=dcaasprod&en=OperationEvent&scopingConditions=[[`"ScaleUnit`",`"dcaasarm-prod-su-1`"]]&conditions=[[`"contextId`",`"%3D%3D`",`"4f8960a2-b031-4aab-ab13-ad5641ca5dd4`"]]&kqlClientQuery=//%20OperationEvent%0Asource%0A|%20sort%20by%20env_time%20desc%0A|%20project%20env_time,%20domainName,%20operationName,%20resultType,%20resultDescription,%20resultSignature,%20invalidReason,%20durationMs,%20activityId,%20contextId%0A%0A//OperationEvent%20%2B%20TraceEvent%0A//%20|%20sort%20by%20env_time%20asc%0A//%20|%20project%20env_time,%20message,%20operationName,%20resultDescription,%20invalidReason,%20resultType,%20tracingLevel%0A//%20|%20where%20resultType%20%3D%3D%20`"Failure`"%20or%20tracingLevel%20%3D%3D%20`"Warning`"%20or%20tracingLevel%20%3D%3D%20`"Error`"%0A&aggregatesVisible=true&aggregates=[`"Count%20by%20resultType`",`"Count%20by%20operationName`"]&chartEditorVisible=true&chartType=line&chartLayers=[[`"New%20Layer`",`"`"]]%20",
                "https://portal.microsoftgeneva.com/logs/dgrep?be=DGrep&offset=-7&offsetUnit=Days&UTC=true&ep=Diagnostics%20PROD&ns=dcaasprod&en=DomainEvaluationEvent&scopingConditions=[[`"ScaleUnit`",`"dcaasarm-prod-su-1`"]]&conditions=[[`"contextId`",`"%3D%3D`",`"4f8960a2-b031-4aab-ab13-ad5641ca5dd4`"]]&kqlClientQuery=//%20DomainEvaluationEvent%0A%0Asource%0A|%20sort%20by%20env_time%20desc%0A|%20project%20env_time,%20domainName,%20operationName,%20evalOperationType,%20resultType,%20resultDescription,%20resultSignature,%20invalidReason,%20durationMs,%20activityId,%20contextId%0A%0A//%20Loadbalancer%20upgrade%20check%0A//%20|%20where%20operationName%20%3D%3D%20`"ReplicaSetLoadblancerSkuEvaluator`"%20//%20UpgradeLoadbalancer%20operation,%20check%20Remediator%20for%20reason%20of%20failure%0A//%20|%20where%20evalOperationType%20%3D%3D%20`"Remediator`"%0A//%20Sync%20and%20network%20check%0A//%20|%20where%20operationName%20contains%20`"Sync`"%20or%20operationName%20contains%20`"network`"%0A%0A//%20DomainEvaluationEvent%20%2B%20TraceEvent%0A//%20|%20sort%20by%20env_time%20asc%0A//%20|%20project%20env_time,%20message,%20operationName,%20resultDescription,%20invalidReason,%20resultType,%20tracingLevel%0A//%20|%20where%20resultType%20%3D%3D%20`"Failure`"%20or%20tracingLevel%20%3D%3D%20`"Warning`"%20or%20tracingLevel%20%3D%3D%20`"Error`"%0A&aggregatesVisible=true&aggregates=[`"Count%20by%20resultSignature`",`"Count%20by%20resultType`",`"Count%20by%20operationName`"]&chartEditorVisible=true&chartType=line&chartLayers=[[`"New%20Layer`",`"`"]]%20",
                "https://portal.microsoftgeneva.com/logs/dgrep?be=DGrep&offset=-15&offsetUnit=Hours&UTC=true&ep=Diagnostics%20PROD&ns=dcaasfleetprod&en=CounterEvent&scopingConditions=[[`"ScaleUnit`",`"dcaasarm-prod-su-1`"],[`"Tenant`",`"4f8960a2-b031-4aab-ab13-ad5641ca5dd4`"]]&conditions=[]&kqlClientQuery=//%20Perfmon%0Asource%0A//%20Overall%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\System\\System%20Up%20Time`"%20//%20In%20seconds,%2086,400%20per%20day.%20%0A|%20where%20CounterName%20%3D%3D%20`"\\Processor(_Total)\\%25%20Processor%20Time`"%20//%20Less%20than%2080%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\Memory\\%25%20Committed%20Bytes%20In%20Use`"%20//%20Less%20then%2080%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\PhysicalDisk(0%20C:)\\%25%20Idle%20Time`"%20//%20OS%20drive:%20aim%20for%20%25%20Idle%20above%2090%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\PhysicalDisk(1%20D:)\\%25%20Idle%20Time`"%20//%20Temp%20%26%20IFM%20Paging%20file%20Drive%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\PhysicalDisk(3%20F:)\\%25%20Idle%20Time`"%20//%20AadDs%20data%20drive:%20AadSyncAgent,%20Ntds,%20PasswordSync,%20SysVol,%20TranslationAgent%0A%0A//%20LSASS%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\Process(lsass)\\%25%20Processor%20Time`"%20//%20Divide%20the%20number%20by%20number%20of%20processors%20for%20true%20%25CPU%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\Process(lsass)\\Virtual%20Bytes`"%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\Process(lsass)\\Handle%20Count`"%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\Process(lsass)\\Pool%20Paged%20Bytes`"%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\Process(lsass)\\Pool%20Nonpaged%20Bytes`"%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\Security%20System-Wide%20Statistics\\NTLM%20Authentications`"%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\Security%20System-Wide%20Statistics\\Kerberos%20Authentications`"%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\DirectoryServices(NTDS)\\LDAP%20Successful%20Binds/sec`"%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\DirectoryServices(NTDS)\\LDAP%20Searches/sec`"%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\DirectoryServices(NTDS)\\LDAP%20Writes/sec`"%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\DirectoryServices(NTDS)\\LDAP%20Bind%20Time`"%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\DirectoryServices(NTDS)\\NTLM%20Binds/sec`"%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\DirectoryServices(NTDS)\\Negotiated%20Binds/sec`"%0A%0A//%20DNS%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\Process(dns)\\%25%20Processor%20Time`"%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\Process(dns)\\Virtual%20Bytes`"%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\Process(dns)\\Handle%20Count`"%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\Process(dns)\\Pool%20Paged%20Bytes`"%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\Process(dns)\\Pool%20Nonpaged%20Bytes`"%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\DNS\\Dynamic%20Update%20Received`"%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\DNS\\Total%20Query%20Received/sec`"%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\DNS\\Recursive%20Queries/sec`"%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\DNS\\Total%20Response%20Sent/sec`"%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\DNS\\TCP%20Query%20Received/sec`"%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\DNS\\UDP%20Query%20Received/sec`"%0A%0A//%20Network%20Interface..%20may%20be%20different%20adapter%20number.%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\Network%20Interface(Microsoft%20Hyper-V%20Network%20Adapter%20_2)\\Bytes%20Total/sec`"%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\Network%20Interface(Microsoft%20Hyper-V%20Network%20Adapter%20_2)\\Bytes%20Sent/sec`"%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\Network%20Interface(Microsoft%20Hyper-V%20Network%20Adapter%20_2)\\Bytes%20Received/sec`"%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\Network%20Interface(Microsoft%20Hyper-V%20Network%20Adapter%20_2)\\Output%20Queue%20Length`"%0A|%20sort%20by%20PreciseTimeStamp%20desc&aggregates=[`"Count%20by%20CounterName`"]&chartsVisible=true&chartEditorVisible=false&chartType=line&chartLayers=[[`"Counter`",`"groupby%20PreciseTimeStamp.roundDown(\`"PT3M\`")%20as%20X,%20RoleInstance\nlet%20Value%20%3D%20Max(CounterValue)`"]]%20",
                "https://portal.microsofticm.com/imp/v3/incidents/omnisearch?searchString=4f8960a2-b031-4aab-ab13-ad5641ca5dd4%20Entra%20Domain%20services"                
                )},
            @{Description='1 General Tenant information (Lite)'; URL=@(
                "https://portal.microsoftgeneva.com/logs/dgrep?be=DGrep&offset=-15&offsetUnit=Hours&UTC=true&ep=Diagnostics%20PROD&ns=dcaasprod&en=DCAnalyticsDataEvent,DomainAnalyticsDataEvent&scopingConditions=[[`"ScaleUnit`",`"dcaasarm-prod-su-1`"]]&conditions=[[`"contextId`",`"%3D%3D`",`"4f8960a2-b031-4aab-ab13-ad5641ca5dd4`"]]&clientQuery=//%20SubscriptionInfo%0Aselect%20env_time,%20domainName,%20contextId%20as%20TenantID,%20clientSubscriptionId%20as%20CustomerSub,%20hostSubscriptionId%20as%20MsftSub,%20vmName%20,region,%20env_cloud_location%20as%20Cloud,%20domainStatus%20as%20Status,%20roleSize%20as%20VmSku,%20ldapsStatus%20as%20Ldap,%20ldapsPublicAccessStatus%20as%20LdapPub,%20syncPasswordFlag%20as%20PwdSync%0Adistinct%0Agroupby%20domainName,%20TenantID,%20CustomerSub,%20MsftSub,%20VmName,%20region,%20Cloud,%20Status,%20VmSku,%20Ldap,%20LdapPub,%20PwdSync%0A&aggregates=[`"Count%20by%20domainStatus`",`"Count%20by%20domainName`",`"Count%20by%20resultType`"]&chartEditorVisible=true&chartType=line&chartLayers=[[`"New%20Layer`",`"`"]]%20",
                "https://portal.microsoftgeneva.com/logs/dgrep?be=DGrep&offset=-7&offsetUnit=Days&UTC=true&ep=Diagnostics%20PROD&ns=dcaasprod&en=OperationEvent&scopingConditions=[[`"ScaleUnit`",`"dcaasarm-prod-su-1`"]]&conditions=[[`"contextId`",`"%3D%3D`",`"4f8960a2-b031-4aab-ab13-ad5641ca5dd4`"]]&kqlClientQuery=//%20OperationEvent%0Asource%0A|%20sort%20by%20env_time%20desc%0A|%20project%20env_time,%20domainName,%20operationName,%20resultType,%20resultDescription,%20resultSignature,%20invalidReason,%20durationMs,%20activityId,%20contextId%0A%0A//OperationEvent%20%2B%20TraceEvent%0A//%20|%20sort%20by%20env_time%20asc%0A//%20|%20project%20env_time,%20message,%20operationName,%20resultDescription,%20invalidReason,%20resultType,%20tracingLevel%0A//%20|%20where%20resultType%20%3D%3D%20`"Failure`"%20or%20tracingLevel%20%3D%3D%20`"Warning`"%20or%20tracingLevel%20%3D%3D%20`"Error`"%0A&aggregatesVisible=true&aggregates=[`"Count%20by%20resultType`",`"Count%20by%20operationName`"]&chartEditorVisible=true&chartType=line&chartLayers=[[`"New%20Layer`",`"`"]]%20",
                "https://portal.microsoftgeneva.com/logs/dgrep?be=DGrep&offset=-7&offsetUnit=Days&UTC=true&ep=Diagnostics%20PROD&ns=dcaasprod&en=DomainEvaluationEvent&scopingConditions=[[`"ScaleUnit`",`"dcaasarm-prod-su-1`"]]&conditions=[[`"contextId`",`"%3D%3D`",`"4f8960a2-b031-4aab-ab13-ad5641ca5dd4`"]]&kqlClientQuery=//%20DomainEvaluationEvent%0A%0Asource%0A|%20sort%20by%20env_time%20desc%0A|%20project%20env_time,%20domainName,%20operationName,%20evalOperationType,%20resultType,%20resultDescription,%20resultSignature,%20invalidReason,%20durationMs,%20activityId,%20contextId%0A%0A//%20Loadbalancer%20upgrade%20check%0A//%20|%20where%20operationName%20%3D%3D%20`"ReplicaSetLoadblancerSkuEvaluator`"%20//%20UpgradeLoadbalancer%20operation,%20check%20Remediator%20for%20reason%20of%20failure%0A//%20|%20where%20evalOperationType%20%3D%3D%20`"Remediator`"%0A//%20Sync%20and%20network%20check%0A//%20|%20where%20operationName%20contains%20`"Sync`"%20or%20operationName%20contains%20`"network`"%0A%0A//%20DomainEvaluationEvent%20%2B%20TraceEvent%0A//%20|%20sort%20by%20env_time%20asc%0A//%20|%20project%20env_time,%20message,%20operationName,%20resultDescription,%20invalidReason,%20resultType,%20tracingLevel%0A//%20|%20where%20resultType%20%3D%3D%20`"Failure`"%20or%20tracingLevel%20%3D%3D%20`"Warning`"%20or%20tracingLevel%20%3D%3D%20`"Error`"%0A&aggregatesVisible=true&aggregates=[`"Count%20by%20resultSignature`",`"Count%20by%20resultType`",`"Count%20by%20operationName`"]&chartEditorVisible=true&chartType=line&chartLayers=[[`"New%20Layer`",`"`"]]%20"
                )},    
            @{Description='2 Loadbalancer Upgrade failure check'; URL=@(
                "https://portal.microsoftgeneva.com/logs/dgrep?be=DGrep&offset=-15&offsetUnit=Hours&UTC=true&ep=Diagnostics%20PROD&ns=dcaasprod&en=OperationEvent&scopingConditions=[[`"ScaleUnit`",`"dcaasarm-prod-su-1`"]]&conditions=[[`"contextId`",`"%3D%3D`",`"4f8960a2-b031-4aab-ab13-ad5641ca5dd4`"],[`"operationName`",`"contains%20any%20of`",`"Loadbalancer,CustomHealthAlert`"]]&kqlClientQuery=//%20Loadbalancer%20Upgrade%20failure%20check%0A//%20%20Check%20ASC%20for%20AADDS109%20(Resources%20cannot%20be%20found)%20or%20AADDS116%20(Network%20resources%20cannot%20be%20used)%0A//%20%20%20%20%20%20Look%20in%20resultSignature%20for%20InvalidReason%20and%20ErrorMessage%20for%20more%20context.%0Asource%0A|%20sort%20by%20env_time%20desc%0A|%20project%20env_time,%20domainName,%20operationName,%20resultType,%20resultSignature,%20durationMs,%20activityId,%20contextId%0A|%20where%20operationName%20!contains%20`"Request`"%0A&aggregates=[`"Count%20by%20resultType`",`"Count%20by%20operationName`"]&chartEditorVisible=true&chartType=line&chartLayers=[[`"New%20Layer`",`"`"]]%20"
                )},
            @{Description='3 Tenant LSASS workload'; URL=@(
                "https://portal.microsoftgeneva.com/logs/dgrep?be=DGrep&offset=-15&offsetUnit=Hours&UTC=true&ep=Diagnostics%20PROD&ns=dcaasfleetprod&en=CounterEvent&scopingConditions=[[`"ScaleUnit`",`"dcaasarm-prod-su-1`"],[`"Tenant`",`"4f8960a2-b031-4aab-ab13-ad5641ca5dd4`"]]&conditions=[]&clientQuery=//%20Tenant%20LSASS%20workload%0A//%20%20%20%20%20%20Tip%201:%20To%20view%20a%20single%20DcName's%20details,%20click%20on%20the%20Aggregates'%20RoleInstance.%20Otherwise,%20the%20chart%20will%20show%20the%20maximum%20of%20the%20two%20DC%20values.%0A//%20%20%20%20%20%20Tip%202:%20To%20get%20a%20better%20view%20of%20the%20pattern%20in%20the%20graph,%20follow%20these%20steps:%0A//%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Select%20'None'%20on%20the%20chart.%0A//%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Toggle%20one%20counter%20at%20a%20time%20to%20get%20a%20full%20scale%20in%20the%20graph.%0A//%20%20%20%20%20%20%0A//%20%20%20%20%20%20\Memory\%25%20Committed%20Bytes%20In%20Use%20>>%20aim%20for%20less%20than%2080%0A//%20%20%20%20%20%20\Processor(_Total)\%25%20Processor%20Time%20>>%20aim%20for%20less%20than%2080%0A//%20%20%20%20%20%20\Process(lsass)\%25%20Processor%20Time%20>>%20aim%20for%20less%20than%2080%20TIMES%20number%20of%20processor(s)%0A//%20%20%20%20%20%20\PhysicalDisk(0%20C:)\%25%20Idle%20Time%20>>%20aim%20for%20greater%20than%2075%25%20idle,%20C%20%3D%20OS%0A//%20%20%20%20%20%20\PhysicalDisk(1%20D:)\%25%20Idle%20Time%20>>%20aim%20for%20greater%20than%2075%25%20idle,%20D%20%3D%20Temp,%20Backup,%20IFM,%20Paging%20File%20%0A//%20%20%20%20%20%20\PhysicalDisk(3%20F:)\%25%20Idle%20Time%20>>%20aim%20for%20greater%20than%2075%25%20idle,%20F%20%3D%20AADDS%20Data,%20ntds.dit,%20sysvols,%20sync,%20audit%20logs%20%0A//%20%0A//%20|%20where%20RoleInstance%20%3D%3D%20`"Pick%20DCName%20from%20Aggregates's%20RoleInstance`"%0A%0A&aggregatesVisible=true&aggregates=[`"Count%20by%20RoleInstance`"]&chartsVisible=true&chartEditorVisible=false&chartType=line&chartLayers=[[`"<80%20`",`"groupby%20PreciseTimeStamp.roundDown(\`"PT3M\`")%20as%20X,%20CounterName\nwhere%20CounterName%20%3D%3D%20\`"\\Memory\\%25%20Committed%20Bytes%20In%20Use\`"%20||%20CounterName%20%3D%3D%20\`"\\Processor(_Total)\\%25%20Processor%20Time\`"\nlet%20for%20%3D%20Max(CounterValue)`"],[`"(<80%25xProc)%20`",`"groupby%20PreciseTimeStamp.roundDown(\`"PT3M\`")%20as%20X,%20CounterName\nwhere%20CounterName%20%3D%3D%20\`"\\Process(lsass)\\%25%20Processor%20Time\`"\nlet%20for%20%3D%20Max(CounterValue)`"],[`"LSASS`",`"groupby%20PreciseTimeStamp.roundDown(\`"PT3M\`")%20as%20X,%20CounterName\nwhere%20CounterName%20%3D%3D%20\`"\\Security%20System-Wide%20Statistics\\NTLM%20Authentications\`"%20||%20CounterName%20%3D%3D%20\`"\\Security%20System-Wide%20Statistics\\Kerberos%20Authentications\`"%20||%20CounterName%20%3D%3D%20\`"\\DirectoryServices(NTDS)\\LDAP%20Searches/sec\`"%20\nlet%20for%20%3D%20Max(CounterValue)`"],[`"Disk`",`"groupby%20PreciseTimeStamp.roundDown(\`"PT5M\`")%20as%20X,%20CounterName\nwhere%20CounterName%20%3D%3D%20\`"\\PhysicalDisk(0%20C:)\\%25%20Idle%20Time\`"%20||%20CounterName%20%3D%3D%20\`"\\PhysicalDisk(1%20D:)\\%25%20Idle%20Time\`"%20||%20CounterName%20%3D%3D%20\`"\\PhysicalDisk(3%20F:)\\%25%20Idle%20Time\`"\nlet%20for%20%3D%20Max(CounterValue)`"],[`"OS`",`"groupby%20PreciseTimeStamp.roundDown(\`"PT5M\`")%20as%20X,%20CounterName\nwhere%20CounterName%20%3D%3D%20\`"\\System\\System%20Up%20Time\`"\nlet%20for%20%3D%20Sum(CounterValue)`"],[`"Memory`",`"groupby%20PreciseTimeStamp.roundDown(\`"PT5M\`")%20as%20X,%20CounterName\nwhere%20CounterName%20%3D%3D%20\`"\\Process(dfsrs)\\Virtual%20Bytes\`"%20||%20CounterName%20%3D%3D%20\`"\\Process(dns)\\Virtual%20Bytes\`"%20||%20CounterName%20%3D%3D%20\`"\\Process(lsass)\\Virtual%20Bytes\`"%20||%20CounterName%20%3D%3D%20\`"\\Process(dfssvc)\\Virtual%20Bytes\`"\nlet%20for%20%3D%20Max(CounterValue)`"]]%20"
                )},
            @{Description='4 LSASS memory pattern'; URL=@(
                "https://portal.microsoftgeneva.com/logs/dgrep?be=DGrep&offset=-60&offsetUnit=Hours&UTC=true&ep=Diagnostics%20PROD&ns=dcaasfleetprod&en=SystemEvents&scopingConditions=[[`"ScaleUnit`",`"dcaasarm-prod-su-1`"],[`"Tenant`",`"4f8960a2-b031-4aab-ab13-ad5641ca5dd4`"]]&conditions=[[`"EventId`",`"contains%20any%20of`",`"19,18`"]]&kqlClientQuery=//%20Windows%20Update%20checks%0Asource%0A|%20sort%20by%20PreciseTimeStamp%20asc%0A|%20project%20PreciseTimeStamp,%20Role,%20RoleInstance,%20DataCenter,%20ProviderName,%20EventId,%20Data1,%20EventData,%20__SourceEvent__%20,%20%20__SourceMoniker__%0A%0A//%20Check%20for%20monthly%20rollup%0A//%20%20%20%20%20%20Event%2018%20%3D%20Reboot,%20Event%2019%20%3D%20Windows%20Update%20(The%20Cumulative%20Update%20is%20typically%20deployed%20within%20a%20week%20of%20the%20second%20Tuesday%20of%20each%20month.)%0A|%20where%20EventData%20contains%20`"Cumulative`"%20or%20EventId%20%3D%3D%20`"18`"&aggregates=[`"Count%20by%20__SourceEvent__`",`"Count%20by%20__SourceMoniker__`",`"Count%20by%20Data1`",`"Count%20by%20EventId`",`"Count%20by%20RoleInstance`"]&chartEditorVisible=true&chartType=column&chartLayers=[[`"New%20Layer`",`"groupby%20DataCenter\nlet%20Count%20%3D%20Count()`"]]%20",
                "https://portal.microsoftgeneva.com/logs/dgrep?be=DGrep&offset=-60&offsetUnit=Hours&UTC=true&ep=Diagnostics%20PROD&ns=dcaasfleetprod&en=CounterEvent&scopingConditions=[[`"ScaleUnit`",`"dcaasarm-prod-su-1`"],[`"Tenant`",`"4f8960a2-b031-4aab-ab13-ad5641ca5dd4`"]]&conditions=[[`"CounterName`",`"contains%20any%20of`",`"\\Process(lsass)\\Virtual%20Bytes,%20\\System\\System%20Up%20Time`"]]&kqlClientQuery=//%20LSASS%20Virtual%20Bytes%0A//%20%20%20%20%20%20Compare%20LSASS%20Virtual%20Bytes%20with%20System%20Up%20Time%20to%20identify%20memory%20leak%20patterns%0Asource%0A|%20where%20CounterName%20%3D%3D%20`"\\Process(lsass)\\Virtual%20Bytes`"%0A//%20|%20where%20CounterName%20%3D%3D%20`"\\System\\System%20Up%20Time`"%20//%20In%20seconds,%2086,400%20per%20day.%20%0A%0A|%20sort%20by%20PreciseTimeStamp%20desc&aggregates=[`"Count%20by%20CounterName`"]&chartsVisible=true&chartEditorVisible=false&chartType=line&chartLayers=[[`"Counter`",`"groupby%20PreciseTimeStamp.roundDown(\`"PT3M\`")%20as%20X,%20RoleInstance\nlet%20Value%20%3D%20Max(CounterValue)`"]]%20"
                )},  
            @{Description='5 Windows Update and Reboot'; URL=@(
                "https://portal.microsoftgeneva.com/logs/dgrep?be=DGrep&offset=-60&offsetUnit=Hours&UTC=true&ep=Diagnostics%20PROD&ns=dcaasfleetprod&en=SystemEvents&scopingConditions=[[`"ScaleUnit`",`"dcaasarm-prod-su-1`"],[`"Tenant`",`"4f8960a2-b031-4aab-ab13-ad5641ca5dd4`"]]&conditions=[[`"EventId`",`"contains%20any%20of`",`"19,18`"]]&kqlClientQuery=//%20Windows%20Update%20checks%0Asource%0A|%20sort%20by%20PreciseTimeStamp%20asc%0A|%20project%20PreciseTimeStamp,%20Role,%20RoleInstance,%20DataCenter,%20ProviderName,%20EventId,%20Data1,%20EventData,%20__SourceEvent__%20,%20%20__SourceMoniker__%0A%0A//%20Check%20for%20monthly%20rollup%0A//%20%20%20%20%20%20Event%2018%20%3D%20Reboot,%20Event%2019%20%3D%20Windows%20Update%20(The%20Cumulative%20Update%20is%20typically%20deployed%20within%20a%20week%20of%20the%20second%20Tuesday%20of%20each%20month.)%0A|%20where%20EventData%20contains%20`"Cumulative`"%20or%20EventId%20%3D%3D%20`"18`"&aggregates=[`"Count%20by%20__SourceEvent__`",`"Count%20by%20__SourceMoniker__`",`"Count%20by%20Data1`",`"Count%20by%20EventId`",`"Count%20by%20RoleInstance`"]&chartEditorVisible=true&chartType=column&chartLayers=[[`"New%20Layer`",`"groupby%20DataCenter\nlet%20Count%20%3D%20Count()`"]]%20"
                )},  
            @{Description='6 PasswordSync (c&p to SAW)'; URL=@(
                "https://portal.microsoftgeneva.com/logs/dgrep?be=DGrep&offset=-2&offsetUnit=Hours&UTC=true&ep=Diagnostics%20PROD&ns=dcaasfleetprod&en=DefaultEventTable,DefaultTraceTable,SecurityEvents&scopingConditions=[[`"Tenant`",`"4f8960a2-b031-4aab-ab13-ad5641ca5dd4`"]]&conditions=[]&kqlClientQuery=//%20PasswordSync,%0A//%20%20To%20run,%20you%20need%20to%20be%20on%20SAW.%20Use%20Alt-L%20to%20copy%20and%20paste%20this%20link%20to%20run%20it%20on%20SAW.%0A%0Asource%0A|%20project%20PreciseTimeStamp,DataCenter,%20Role,%20Message,%20EventDescription,%20ProviderName,%20OpcodeName%0A//%20Replace%20`"UserName`"%20with%20the%20name%20of%20the%20problem%20user.%0A|%20where%20ProviderName%20contains%20`"PasswordSync`"%20or%20*%20contains%20`"UserName`"%0A|%20where%20Message%20!%3D%20`"`"%20or%20EventDescription%20!%3D%20`"`"%0A|%20sort%20by%20PreciseTimeStamp%20asc&chartEditorVisible=true&chartType=line&chartLayers=[[`"New%20Layer`",`"`"]]%20"
                )},
            @{Description='7 SyncOperationEvent (c&p to SAW)'; URL=@(
                "https://portal.microsoftgeneva.com/logs/dgrep?be=DGrep&offset=-15&offsetUnit=Hours&UTC=true&ep=Diagnostics%20PROD&ns=dcaasfleetprod&en=SyncOperationEvent&scopingConditions=[[`"Tenant`",`"4f8960a2-b031-4aab-ab13-ad5641ca5dd4`"]]&conditions=[]&kqlClientQuery=//%20>>>>%20SAW%20required,%20Alt-L,%20C%26P%20to%20SAW%20<<<<%0A%0A//%20SyncOperationEvent%0A//%20Records%20all%20sync%20operations%20made,%20success%20or%20failure.%20Includes%20object%20additions,%20modifications,%20deletions,%20manager%20%26%20membership%20additions%20%26%20removals,%20and%20escrow%20retries.%0Asource%0A|%20sort%20by%20env_time%20desc%0A|%20project%20env_time,%20aadResourceId,%20resourceType,syncOperationType,%20resultType,%20operationName,resultDescription,%20resultSignature,%20durationMs,%20resourceId,%20activityId,%20correlationId,%20steadyStateTime,%20env_cloud_location,%20env_cloud_name,%20env_cloud_role,%20env_cloud_roleInstance,%20operationVersion,providerName%0A%0A%0A//TraceEvent%20%20<<--%20add%20TraceEvent%20table%20and%20specific%20activityId%20to%20Filtering%20Conditions%20%0A//%20|%20where%20providerName%20%3D%3D%20`"AadSyncAgent`"%0A//%20|%20sort%20by%20env_time%20asc,%20env_seqNum%20asc%0A//%20|%20project%20env_time,%20message,%20env_seqNum,%20activityId,%20%20env_cloud_location,%20env_cloud_roleInstance,%20resultType,%20tracingLevel,%20providerName%0A&chartEditorVisible=true&chartType=line&chartLayers=[[`"New%20Layer`",`"`"]]%20"
                )}, 
            @{Description='8 Subscription ID check'; URL=@(
                "https://portal.microsoftgeneva.com/logs/dgrep?be=DGrep&offset=-15&offsetUnit=Hours&UTC=true&ep=Diagnostics%20PROD&ns=dcaasprod&en=DomainAnalyticsDataEvent&scopingConditions=[[`"ScaleUnit`",`"dcaasarm-prod-su-1`"]]&conditions=[[`"clientSubscriptionId`",`"%3D%3D`",`"4f8960a2-b031-4aab-ab13-ad5641ca5dd4`"]]&clientQuery=//%20SubscriptionInfo%0Aselect%20env_time,%20domainName,%20contextId%20as%20TenantID,%20clientSubscriptionId%20as%20CustomerSub,%20hostSubscriptionId%20as%20MsftSub,%20region,%20env_cloud_location%20as%20Cloud,%20domainStatus%20as%20Status,%20roleSize%20as%20VmSku,%20ldapsStatus%20as%20Ldap,%20ldapsPublicAccessStatus%20as%20LdapPub,%20syncPasswordFlag%20as%20PwdSync%0Adistinct%0Agroupby%20domainName,%20TenantID,%20CustomerSub,%20MsftSub,%20region,%20Cloud,%20Status,%20VmSku,%20Ldap,%20LdapPub,%20PwdSync%0A//If%20not%20found,%20quick%20reply%20with:%0A//%20Can%20you%20confirm%20if%20we're%20searching%20for%20Entra%20Domain%20Service?%20I%20can't%20find%20any%20tenant%20for%20Entra%20Domain%20Service%20under%20subscription%20ID%2034f62f11-4838-4e24-9319-8444d87fab4a.%0A//%20Maybe%20we're%20looking%20for%20AAD%20Distributed%20Directory%20Services\ProvisioningWebService%20(Entra%20ID),%20%20instead%20of%20Entra%20Domain%20Service.%20Entra%20DS%20is%20two%20VMs%20running%20Windows%20active%20directory%20services%20that%20offer%20customers%20on-prem%20AD%20functions.&aggregates=[`"Count%20by%20domainStatus`",`"Count%20by%20domainName`",`"Count%20by%20resultType`"]&chartEditorVisible=true&chartType=line&chartLayers=[[`"New%20Layer`",`"`"]]%20"
                )}, 
    
            @{Description='>> Service Log Queries Wiki  <<'; URL=@(
                "https://supportability.visualstudio.com/AzureAD/_wiki/wikis/AzureAD/365188/Azure-AD-Domain-Services-Service-Log-Queries"
                )}                
        )
        foreach ($scenario in $scenarios) { $comboBox.Items.Add($scenario.Description) > $null}
        $comboBox.SelectedIndex = $DefaultSelection 
        $form.Controls.Add($comboBox)
        $form.Topmost = $true
    $result = $form.ShowDialog()
# Process OK Button
    if ($result -eq [System.Windows.Forms.DialogResult]::OK) {
        $TenantID = $($textBox.Text)
            $TenantIDFormat = [regex]"[A-Za-z0-9]{8}-[A-Za-z0-9]{4}-[A-Za-z0-9]{4}-[A-Za-z0-9]{4}-[A-Za-z0-9]{12}"
            # Write-Host "TenantID before cleanup: $TenantID"
            if ($TenantID -match $TenantIDFormat) {
                $TenantID = $matches[0]
                    # Write-Host "TenantID after cleanup: $TenantID"
                    $selectedEndpoint = @($endpointProd, $endpointFairfax, $endpointMooncake) | Where-Object { $_.Checked } | Select-Object -ExpandProperty Text
                    $selectedURL = $scenarios[$comboBox.SelectedIndex].URL
                    # Write-Host "Endpoints: $selectedEndpoint", "`nScenario URL: $selectedURL"
                        switch ($selectedEndpoint) {
                            '&PROD' {  
                                foreach ($url in $selectedURL) {
                                    $url = $url -replace $refTenantID, $TenantID  
                                    Start-Process $url
                                }
                            }  
                            '&Fairfax' {  
                                foreach ($url in $selectedURL) {
                                    $url = $url -replace $refTenantID, $TenantID  
                                    $url = $url -replace "Diagnostics%20PROD", "CA%20Fairfax"  
                                    $url = $url -replace "dcaasprod", "aaddcaasff"   
                                    $url = $url -replace "dcaasfleetprod", "dcaasfffleetprod" 
                                    $url = $url -replace "dcaasarm-prod-su-1", "dcaasarm-ffprod-su-1"   
                                    Start-Process $url
                                }
                            }  
                            '&Mooncake' {  
                                foreach ($url in $selectedURL) {
                                    $url = $url -replace $refTenantID, $TenantID  
                                    $url = $url -replace "Diagnostics%20PROD", "CA%20Mooncake"  
                                    $url = $url -replace "dcaasprod", "aaddcaasmc"    
                                    $url = $url -replace "dcaasfleetprod", "dcaasmcfleetprod" 
                                    $url = $url -replace "dcaasarm-prod-su-1", "dcaasarm-mcprod-su-1"  
                                    Start-Process $url
                                }
                            }  
                            Default { break }
                        }
            } else {
                Add-Type -AssemblyName System.Windows.Forms  
                $MessageBoxButtons = [System.Windows.Forms.MessageBoxButtons]::OK  
                $MessageBoxIcon = [System.Windows.Forms.MessageBoxIcon]::Error  
                $MessageBody = "No Tenant ID found in the entered text."  
                $MessageTitle = "No Tenant ID found"  
                [System.Windows.Forms.MessageBox]::Show($MessageBody, $MessageTitle, $MessageBoxButtons, $MessageBoxIcon)  
            }
        $form.Close()
    }
